{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/quanteondev/Downloads/wildlife-/app/api/detect/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { writeFile, unlink } from \"fs/promises\"\nimport { join } from \"path\"\nimport { tmpdir } from \"os\"\nimport { spawn } from \"child_process\"\nimport path from \"path\"\n\n// This uses the local YOLO Python script for accurate wildlife detection\nexport async function POST(request: NextRequest) {\n  let tempFilePath = \"\"\n  try {\n    const formData = await request.formData()\n    const file = formData.get(\"file\") as File\n\n    if (!file) {\n      return NextResponse.json({ error: \"No file provided\" }, { status: 400 })\n    }\n\n    // Save file temporarily\n    const buffer = Buffer.from(await file.arrayBuffer())\n    const tempDir = tmpdir()\n    const fileName = `upload-${Date.now()}-${Math.random().toString(36).substring(7)}.jpg`\n    tempFilePath = join(tempDir, fileName)\n    \n    await writeFile(tempFilePath, buffer)\n\n    // Run Python detection script\n    const projectRoot = process.cwd()\n    const pythonScript = join(projectRoot, \"detect_cli.py\")\n    const pythonPath = join(projectRoot, \"venv\", \"bin\", \"python\")\n\n    const detectionResult = await runPythonScript(pythonPath, pythonScript, tempFilePath)\n\n    return NextResponse.json(detectionResult)\n\n  } catch (error) {\n    console.error(\"Detection error:\", error)\n    return NextResponse.json({ error: \"Detection failed: \" + (error as Error).message }, { status: 500 })\n  } finally {\n    // Cleanup temp file\n    if (tempFilePath) {\n      try {\n        await unlink(tempFilePath)\n      } catch (e) {\n        console.error(\"Failed to delete temp file:\", e)\n      }\n    }\n  }\n}\n\nfunction runPythonScript(pythonPath: string, scriptPath: string, imagePath: string): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const process = spawn(pythonPath, [scriptPath, imagePath])\n    \n    let stdoutData = \"\"\n    let stderrData = \"\"\n\n    process.stdout.on(\"data\", (data) => {\n      stdoutData += data.toString()\n    })\n\n    process.stderr.on(\"data\", (data) => {\n      stderrData += data.toString()\n    })\n\n    process.on(\"close\", (code) => {\n      if (code !== 0) {\n        console.error(\"Python script error:\", stderrData)\n        reject(new Error(`Python script exited with code ${code}: ${stderrData}`))\n        return\n      }\n\n      try {\n        const result = JSON.parse(stdoutData)\n        if (result.error) {\n          reject(new Error(result.error))\n        } else {\n          resolve(result)\n        }\n      } catch (e) {\n        console.error(\"Failed to parse Python output:\", stdoutData)\n        reject(new Error(\"Failed to parse detection results\"))\n      }\n    })\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAIO,eAAe,KAAK,OAAoB;IAC7C,IAAI,eAAe;IACnB,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,wBAAwB;QACxB,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QACjD,MAAM,UAAU,IAAA,uGAAM;QACtB,MAAM,WAAW,CAAC,OAAO,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG,IAAI,CAAC;QACtF,eAAe,IAAA,yGAAI,EAAC,SAAS;QAE7B,MAAM,IAAA,kIAAS,EAAC,cAAc;QAE9B,8BAA8B;QAC9B,MAAM,cAAc,QAAQ,GAAG;QAC/B,MAAM,eAAe,IAAA,yGAAI,EAAC,aAAa;QACvC,MAAM,aAAa,IAAA,yGAAI,EAAC,aAAa,QAAQ,OAAO;QAEpD,MAAM,kBAAkB,MAAM,gBAAgB,YAAY,cAAc;QAExE,OAAO,gJAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,uBAAuB,AAAC,MAAgB,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrG,SAAU;QACR,oBAAoB;QACpB,IAAI,cAAc;YAChB,IAAI;gBACF,MAAM,IAAA,+HAAM,EAAC;YACf,EAAE,OAAO,GAAG;gBACV,QAAQ,KAAK,CAAC,+BAA+B;YAC/C;QACF;IACF;AACF;AAEA,SAAS,gBAAgB,UAAkB,EAAE,UAAkB,EAAE,SAAiB;IAChF,OAAO,IAAI,QAAQ,CAAC,SAAS;QAC3B,MAAM,WAAU,IAAA,4HAAK,EAAC,YAAY;YAAC;YAAY;SAAU;QAEzD,IAAI,aAAa;QACjB,IAAI,aAAa;QAEjB,SAAQ,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;YACzB,cAAc,KAAK,QAAQ;QAC7B;QAEA,SAAQ,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC;YACzB,cAAc,KAAK,QAAQ;QAC7B;QAEA,SAAQ,EAAE,CAAC,SAAS,CAAC;YACnB,IAAI,SAAS,GAAG;gBACd,QAAQ,KAAK,CAAC,wBAAwB;gBACtC,OAAO,IAAI,MAAM,CAAC,+BAA+B,EAAE,KAAK,EAAE,EAAE,YAAY;gBACxE;YACF;YAEA,IAAI;gBACF,MAAM,SAAS,KAAK,KAAK,CAAC;gBAC1B,IAAI,OAAO,KAAK,EAAE;oBAChB,OAAO,IAAI,MAAM,OAAO,KAAK;gBAC/B,OAAO;oBACL,QAAQ;gBACV;YACF,EAAE,OAAO,GAAG;gBACV,QAAQ,KAAK,CAAC,kCAAkC;gBAChD,OAAO,IAAI,MAAM;YACnB;QACF;IACF;AACF"}}]
}